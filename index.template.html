<!DOCTYPE html>
<html lang="de" class="dark">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>uebertre1ber Dashboard // PRO</title>
  <meta name="description"
    content="FACEIT ELO Dashboard ‚Äì Live tracking, stats, and analysis for the uebertre1ber crew." />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap"
    rel="stylesheet">
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        fontFamily: {
          sans: ['Inter', 'sans-serif'],
          mono: ['JetBrains Mono', 'monospace'],
        },
        extend: {
          colors: {
            faceit: '#FF5500',
            dark: '#050510',
            'neon-blue': '#00f2ff',
            'neon-purple': '#bd00ff',
            'glass-border': 'rgba(255, 255, 255, 0.05)',
            'glass-bg': 'rgba(20, 20, 30, 0.4)',
          },
          backgroundImage: {
            'cyber-gradient': 'linear-gradient(135deg, rgba(5,5,16,1) 0%, rgba(10,10,30,1) 50%, rgba(5,5,16,1) 100%)',
          },
          boxShadow: {
            'neon': '0 0 10px rgba(0, 242, 255, 0.3), 0 0 20px rgba(0, 242, 255, 0.1)',
            'neon-orange': '0 0 10px rgba(255, 85, 0, 0.3), 0 0 20px rgba(255, 85, 0, 0.1)',
          }
        }
      }
    }
  </script>
  <style>
    body {
      background-color: #050510;
      background-image:
        radial-gradient(circle at 10% 20%, rgba(0, 242, 255, 0.05) 0%, transparent 40%),
        radial-gradient(circle at 90% 80%, rgba(189, 0, 255, 0.05) 0%, transparent 40%);
      background-attachment: fixed;
    }

    .glass-panel {
      background: rgba(20, 20, 30, 0.6);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.05);
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
    }

    .glass-card {
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.03);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .glass-card:hover {
      transform: translateY(-2px);
      background: rgba(255, 255, 255, 0.05);
      border-color: rgba(0, 242, 255, 0.2);
      box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.5);
    }

    /* Desktop table */
    table {
      border-collapse: separate;
      border-spacing: 0 8px;
      width: 100%;
    }

    th {
      font-family: 'Inter', sans-serif;
      font-weight: 600;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: rgba(255, 255, 255, 0.4);
      font-size: 0.75rem;
      padding: 1rem;
    }

    td {
      padding: 1rem;
    }

    tr.player-row td:first-child {
      border-top-left-radius: 12px;
      border-bottom-left-radius: 12px;
    }

    tr.player-row td:last-child {
      border-top-right-radius: 12px;
      border-bottom-right-radius: 12px;
    }

    tr.details-row td {
      border-radius: 12px;
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: #050510;
    }

    ::-webkit-scrollbar-thumb {
      background: #333;
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #FF5500;
    }

    .text-glow {
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
    }

    .text-glow-blue {
      text-shadow: 0 0 10px rgba(0, 242, 255, 0.5);
    }

    .text-glow-orange {
      text-shadow: 0 0 10px rgba(255, 85, 0, 0.5);
    }

    .level-badge {
      clip-path: polygon(10% 0, 100% 0, 90% 100%, 0% 100%);
    }

    /* Mobile card layout */
    @media (max-width: 768px) {
      .desktop-table {
        display: none !important;
      }

      .mobile-cards {
        display: flex !important;
      }

      .hero-stats-grid {
        grid-template-columns: 1fr 1fr !important;
      }

      .awards-grid {
        grid-template-columns: 1fr 1fr !important;
      }
    }

    @media (min-width: 769px) {
      .mobile-cards {
        display: none !important;
      }
    }

    /* Comparison chart section */
    .comparison-chip {
      cursor: pointer;
      transition: all 0.2s;
    }

    .comparison-chip:hover {
      transform: scale(1.05);
    }

    .comparison-chip.active {
      border-color: rgba(0, 242, 255, 0.5);
      background: rgba(0, 242, 255, 0.1);
    }
  </style>
</head>

<body class="min-h-screen text-gray-200 font-sans selection:bg-neon-blue selection:text-black">

  <!-- Background Mesh -->
  <div class="fixed inset-0 pointer-events-none z-[-1] overflow-hidden">
    <div class="absolute top-[-20%] left-[20%] w-[60%] h-[60%] bg-blue-500/5 rounded-full blur-[150px] animate-pulse">
    </div>
    <div class="absolute bottom-[-20%] right-[20%] w-[60%] h-[60%] bg-purple-500/5 rounded-full blur-[150px]"
      style="animation-delay: 2s"></div>
  </div>

  <!-- Header -->
  <header class="py-10 flex flex-col items-center justify-center gap-6 relative">
    <div class="absolute top-0 w-full h-px bg-gradient-to-r from-transparent via-white/10 to-transparent"></div>

    <div class="relative group cursor-pointer hover:scale-105 transition-transform duration-500">
      <div
        class="absolute -inset-2 bg-gradient-to-r from-faceit to-orange-600 rounded-full blur-xl opacity-20 group-hover:opacity-40 transition duration-500">
      </div>
      <img src="icons/levels/uebertreiber_logo.png" alt="uebertre1ber" class="relative w-64 md:w-80 drop-shadow-2xl" />
    </div>

    <!-- Hero Stats Grid -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 w-full max-w-5xl px-4 mt-4 hero-stats-grid">
      <!-- The King -->
      <div class="glass-panel p-4 rounded-xl flex items-center gap-4 relative overflow-hidden group">
        <div
          class="absolute right-0 top-0 w-24 h-24 bg-yellow-500/10 rounded-full blur-2xl -mr-10 -mt-10 group-hover:bg-yellow-500/20 transition">
        </div>
        <div class="w-12 h-12 rounded-lg bg-yellow-500/10 flex items-center justify-center text-2xl">üëë</div>
        <div>
          <p class="text-xs uppercase tracking-widest text-white/40 font-bold">The King</p>
          <p id="hero-king-name" class="font-bold text-white text-lg tracking-tight">‚Äî</p>
          <p id="hero-king-elo" class="font-mono text-yellow-500 text-sm">0 ELO</p>
        </div>
      </div>

      <!-- MVP -->
      <div class="glass-panel p-4 rounded-xl flex items-center gap-4 relative overflow-hidden group">
        <div
          class="absolute right-0 top-0 w-24 h-24 bg-green-500/10 rounded-full blur-2xl -mr-10 -mt-10 group-hover:bg-green-500/20 transition">
        </div>
        <div class="w-12 h-12 rounded-lg bg-green-500/10 flex items-center justify-center text-2xl">üî•</div>
        <div>
          <p class="text-xs uppercase tracking-widest text-white/40 font-bold">MVP</p>
          <p id="hero-mvp-name" class="font-bold text-white text-lg tracking-tight">‚Äî</p>
          <p id="hero-mvp-diff" class="font-mono text-green-400 text-sm">+0</p>
        </div>
      </div>

      <!-- Opfer -->
      <div class="glass-panel p-4 rounded-xl flex items-center gap-4 relative overflow-hidden group">
        <div
          class="absolute right-0 top-0 w-24 h-24 bg-red-500/10 rounded-full blur-2xl -mr-10 -mt-10 group-hover:bg-red-500/20 transition">
        </div>
        <div class="w-12 h-12 rounded-lg bg-red-500/10 flex items-center justify-center text-2xl">üíÄ</div>
        <div>
          <p class="text-xs uppercase tracking-widest text-white/40 font-bold">Opfer</p>
          <p id="hero-down-name" class="font-bold text-white text-lg tracking-tight">‚Äî</p>
          <p id="hero-down-diff" class="font-mono text-red-400 text-sm">-0</p>
        </div>
      </div>

      <!-- Tracked -->
      <div class="glass-panel p-4 rounded-xl flex items-center gap-4 relative overflow-hidden group">
        <div
          class="absolute right-0 top-0 w-24 h-24 bg-blue-500/10 rounded-full blur-2xl -mr-10 -mt-10 group-hover:bg-blue-500/20 transition">
        </div>
        <div class="w-12 h-12 rounded-lg bg-blue-500/10 flex items-center justify-center text-2xl">üìä</div>
        <div>
          <p class="text-xs uppercase tracking-widest text-white/40 font-bold">Tracked</p>
          <p class="font-bold text-white text-lg tracking-tight"><span
              class="text-blue-400"><!-- INSERT_PLAYER_COUNT --></span> Players</p>
          <p class="text-xs text-white/30">Live Updates</p>
        </div>
      </div>
    </div>
  </header>

  <main class="flex-grow w-full max-w-7xl mx-auto p-4 flex flex-col gap-6 z-10">

    <!-- Awards Section -->
    <section id="awards-section" class="px-2">
      <h2 class="text-xs uppercase tracking-widest text-white/30 font-bold mb-4 flex items-center gap-2">
        <span>üèÜ</span> Awards (Last 30 Matches)
      </h2>
      <!-- INSERT_AWARDS_SECTION -->
    </section>

    <!-- Controls Toolbar -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 px-2">
      <!-- Search -->
      <div class="relative w-full sm:w-64">
        <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-white/30" fill="none" viewBox="0 0 24 24"
          stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
        <input id="searchInput" type="text" placeholder="Spieler suchen..."
          class="w-full pl-10 pr-4 py-2.5 rounded-xl bg-[#0a0a14]/80 border border-gray-700/50 text-sm text-white placeholder:text-white/30 focus:outline-none focus:border-neon-blue/50 focus:shadow-neon transition-all backdrop-blur-sm" />
      </div>
      <!-- Time Filter -->
      <div
        class="flex items-center gap-2 bg-[#0a0a14]/80 p-1.5 rounded-xl border border-gray-700/50 shadow-lg backdrop-blur-sm">
        <button
          class="time-filter active px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider transition-all bg-white/10 text-white shadow-inner"
          data-val="daily">Daily</button>
        <button
          class="time-filter px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider text-gray-400 hover:text-white hover:bg-white/5 transition-all"
          data-val="weekly">Weekly</button>
        <button
          class="time-filter px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider text-gray-400 hover:text-white hover:bg-white/5 transition-all"
          data-val="monthly">Monthly</button>
        <button
          class="time-filter px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider text-gray-400 hover:text-white hover:bg-white/5 transition-all"
          data-val="yearly">Yearly</button>
      </div>
    </div>

    <!-- Desktop Table -->
    <div class="overflow-x-auto pb-4 px-2 desktop-table">
      <table class="w-full">
        <thead>
          <tr class="text-xs uppercase tracking-wider text-white/30 text-left">
            <th data-sort="nickname" class="p-4 cursor-pointer hover:text-white transition-colors font-medium">Player
            </th>
            <th data-sort="elo" class="p-4 cursor-pointer hover:text-white transition-colors font-medium">ELO</th>
            <th data-sort="diff" class="p-4 cursor-pointer hover:text-white transition-colors font-medium text-center">
              Gain</th>
            <th data-sort="level" class="p-4 cursor-pointer hover:text-white transition-colors font-medium text-center">
              Lvl</th>
            <th data-sort="winrate" class="p-4 cursor-pointer hover:text-white transition-colors font-medium">
              Performance (Last 30)</th>
            <th data-sort="matches"
              class="p-4 cursor-pointer hover:text-white transition-colors font-medium text-right">Matches</th>
            <th data-sort="last" class="p-4 cursor-pointer hover:text-white transition-colors font-medium text-right">
              Last Match</th>
          </tr>
        </thead>
        <tbody id="playerTableBody" class="space-y-2">
          <!-- INSERT_ELO_TABLE_HERE -->
        </tbody>
      </table>
    </div>

    <!-- Mobile Cards (hidden on desktop) -->
    <div class="mobile-cards flex-col gap-3 px-2" style="display: none;">
      <!-- Populated by JS -->
    </div>

    <!-- ELO Comparison Chart -->
    <section id="comparison-section" class="px-2 mt-4">
      <h2 class="text-xs uppercase tracking-widest text-white/30 font-bold mb-4 flex items-center gap-2">
        <span>üìà</span> ELO Vergleich
      </h2>
      <div id="comparison-chips" class="flex flex-wrap gap-2 mb-4"></div>
      <div class="glass-panel rounded-xl p-4 relative overflow-hidden">
        <div class="h-64 w-full">
          <canvas id="comparison-chart"></canvas>
        </div>
      </div>
    </section>

    <div class="text-center text-xs text-white/20 mt-4 mb-4">
      Last Update: <span class="text-white/40 font-mono"><!-- INSERT_LAST_UPDATED --></span>
    </div>

  </main>

  <!-- Footer -->
  <footer class="py-6 text-center z-10 relative">
    <div
      class="inline-flex items-center gap-2 px-4 py-2 rounded-full glass-panel text-xs text-white/40 hover:text-white/60 transition-colors">
      <span>Dashboard by <a href="https://www.faceit.com/de/players/sha-" target="_blank"
          class="font-bold text-white hover:text-neon-blue transition-colors">sha</a></span>
    </div>
  </footer>

  <script>window.ELO_DATA = null;</script>
  <!-- INSERT_HISTORY_DATA -->
  <!-- INSERT_COMPARISON_DATA -->

  <script>
    // --- State ---
    let currentRange = 'daily';
    let currentSort = { col: 'elo', asc: false };

    // --- DOM Elements ---
    const tableBody = document.getElementById('playerTableBody');
    const searchInput = document.getElementById('searchInput');
    const filterButtons = document.querySelectorAll('.time-filter');

    // --- Relative Time ---
    function relativeTime(tsSeconds) {
      if (!tsSeconds || tsSeconds === 0) return "‚Äî";
      const now = Date.now() / 1000;
      const diff = now - tsSeconds;

      if (diff < 60) return "gerade eben";

      const mins = Math.floor(diff / 60);
      if (mins < 60) return `vor ${mins} Min`;

      const hours = Math.floor(diff / 3600);
      if (hours < 24) return `vor ${hours} Std`;

      if (diff < 172800) return "gestern";

      const days = Math.floor(diff / 86400);
      if (days < 7) return `vor ${days} Tagen`;

      const weeks = Math.floor(diff / 604800);
      if (weeks < 4) return `vor ${weeks} ${weeks === 1 ? 'Woche' : 'Wochen'}`;

      const months = Math.floor(diff / 2592000); // 30 days
      if (months < 12) return `vor ${months} ${months === 1 ? 'Monat' : 'Monaten'}`;

      const years = Math.floor(diff / 31536000); // 365 days
      return `vor ${years} ${years === 1 ? 'Jahr' : 'Jahren'}`;
    }

    // Apply relative time to all last match cells
    function applyRelativeTime() {
      document.querySelectorAll('.last-match-cell').forEach(cell => {
        const ts = parseInt(cell.dataset.ts);
        if (ts > 0) {
          const absTime = cell.textContent.trim();
          const rel = relativeTime(ts);
          cell.innerHTML = `<span title="${absTime}">${rel}</span>`;
        }
      });
    }

    // --- Search ---
    searchInput.addEventListener('input', () => {
      const query = searchInput.value.toLowerCase().trim();
      document.querySelectorAll("tr.player-row").forEach(row => {
        const name = (row.dataset.nickname || "").toLowerCase();
        const match = !query || name.includes(query);
        row.style.display = match ? '' : 'none';
        const pid = row.dataset.playerId;
        const details = document.querySelector(`.details-row[data-player-id="${pid}"]`);
        if (details && !match) details.classList.add('hidden');
      });
      buildMobileCards();
    });

    // --- Time Filter ---
    filterButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        filterButtons.forEach(b => {
          b.className = "time-filter px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider text-gray-400 hover:text-white hover:bg-white/5 transition-all";
        });
        btn.className = "time-filter active px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider transition-all bg-gradient-to-r from-blue-600 to-indigo-600 text-white shadow-neon";
        currentRange = btn.dataset.val;
        updateView();
      });
    });

    // Sort Headers
    document.querySelectorAll('th[data-sort]').forEach(th => {
      th.addEventListener('click', () => {
        const col = th.dataset.sort;
        if (currentSort.col === col) {
          currentSort.asc = !currentSort.asc;
        } else {
          currentSort.col = col;
          currentSort.asc = false;
        }
        sortRows(currentSort.col, currentSort.asc);
        updateViewHeaders();
      });
    });

    function updateViewHeaders() {
      document.querySelectorAll('th[data-sort]').forEach(th => {
        th.classList.remove('text-white', 'text-neon-blue');
        if (th.dataset.sort === currentSort.col) {
          th.classList.add('text-neon-blue');
        }
      });
    }

    // --- Core Logic ---
    function updateView() {
      try {
        const snap = window.ELO_DATA ? window.ELO_DATA[currentRange] : null;
        if (!snap) return;

        const lookup = Object.fromEntries(snap.map(p => [p.playerId, p.elo]));
        let bestDiff = -9999;
        let worstDiff = 9999;
        let mvpName = "‚Äî";
        let downName = "‚Äî";
        let kingElo = -1;
        let kingName = "‚Äî";

        document.querySelectorAll("tr.player-row").forEach(row => {
          row.style.display = '';
          const pid = row.dataset.playerId;
          const currentElo = parseInt(row.dataset.elo || 0);
          const name = row.querySelector('.nickname-link').textContent.trim();

          if (currentElo > kingElo) {
            kingElo = currentElo;
            kingName = name;
          }

          const prev = lookup[pid];
          const cell = row.querySelector(".elo-diff");
          let diffVal = 0;

          if (prev == null) {
            cell.innerHTML = '<span class="text-white/20">‚Äî</span>';
          } else {
            const diff = currentElo - prev;
            diffVal = diff;
            const isPlus = diff > 0;
            const isZero = diff === 0;
            const color = isPlus ? 'text-green-400' : (isZero ? 'text-gray-500' : 'text-red-400');
            const bg = isPlus ? 'bg-green-500/10' : (isZero ? 'bg-white/5' : 'bg-red-500/10');
            const sign = isPlus ? '+' : '';
            cell.innerHTML = `<div class="inline-flex items-center justify-center min-w-[3rem] px-2 py-1 rounded-md ${bg} ${color} font-mono font-bold text-sm border border-white/5 shadow-inner">${sign}${diff}</div>`;
          }

          row.dataset.diff = diffVal;
          if (diffVal > bestDiff) { bestDiff = diffVal; mvpName = name; }
          if (diffVal < worstDiff) { worstDiff = diffVal; downName = name; }
        });

        // Fix: When nobody lost ELO, show lowest gain instead
        if (worstDiff >= 0) {
          if (worstDiff > 0) {
            // Everyone gained ‚Äì show the person who gained least
            document.getElementById('hero-down-name').textContent = downName;
            document.getElementById('hero-down-diff').textContent = "+" + worstDiff + " üòÖ";
            document.getElementById('hero-down-diff').className = "font-mono text-sm text-yellow-400";
          } else {
            // Everyone at 0
            document.getElementById('hero-down-name').textContent = "Alle im Plus üí™";
            document.getElementById('hero-down-diff').textContent = "¬±0";
            document.getElementById('hero-down-diff').className = "font-mono text-sm text-gray-500";
          }
        } else {
          document.getElementById('hero-down-name').textContent = downName;
          document.getElementById('hero-down-diff').textContent = worstDiff;
          document.getElementById('hero-down-diff').className = "font-mono text-sm text-red-400";
        }

        sortRows(currentSort.col, currentSort.asc);

        document.getElementById('hero-king-name').textContent = kingName;
        document.getElementById('hero-king-elo').textContent = kingElo + " ELO";

        if (bestDiff > 0) {
          document.getElementById('hero-mvp-name').textContent = mvpName;
          document.getElementById('hero-mvp-diff').textContent = "+" + bestDiff;
          document.getElementById('hero-mvp-diff').className = "font-mono text-sm text-green-400";
        } else {
          document.getElementById('hero-mvp-name').textContent = "Keiner am Grinden üò¥";
          document.getElementById('hero-mvp-diff').textContent = "¬±0";
          document.getElementById('hero-mvp-diff').className = "font-mono text-sm text-gray-500";
        }

        buildMobileCards();
      } catch (e) { console.error(e); }
    }

    function sortRows(col, asc) {
      const rows = Array.from(document.querySelectorAll('.player-row'));
      const container = document.getElementById('playerTableBody');

      rows.sort((a, b) => {
        const valA = getVal(a, col);
        const valB = getVal(b, col);
        if (valA < valB) return asc ? -1 : 1;
        if (valA > valB) return asc ? 1 : -1;
        return 0;
      });

      rows.forEach(row => {
        container.appendChild(row);
        const pid = row.dataset.playerId;
        const details = document.querySelector(`.details-row[data-player-id="${pid}"]`);
        if (details) container.appendChild(details);
      });
      buildMobileCards();

      updateViewHeaders();
    }

    function getVal(row, col) {
      if (col === 'elo') return parseInt(row.dataset.elo || 0);
      if (col === 'nickname') return (row.dataset.nickname || "").toLowerCase();
      if (col === 'diff') return parseInt(row.dataset.diff || 0);
      if (col === 'level') return parseInt(row.dataset.level || 0);
      if (col === 'winrate') return parseFloat(row.dataset.winrate || 0);
      if (col === 'matches') return parseInt(row.dataset.matches || 0);
      if (col === 'last') return parseInt(row.dataset.lastTs || row.dataset.last || 0);
      return 0;
    }

    // --- Details Toggle & Chart ---
    const charts = {};

    document.addEventListener("click", e => {
      if (e.target.closest("a")) return;
      if (e.target.closest("input")) return;

      const row = e.target.closest("tr.player-row");
      if (!row) return;

      const pid = row.dataset.playerId;
      const toggle = row.querySelector(".toggle-details");
      const detailRow = document.querySelector(`tr.details-row[data-player-id="${pid}"]`);

      if (detailRow) {
        detailRow.classList.toggle("hidden");
        const isHidden = detailRow.classList.contains("hidden");
        if (toggle) toggle.style.transform = isHidden ? "rotate(0deg)" : "rotate(90deg)";

        if (!isHidden) {
          // Radar Chart Init
          const canvasRadar = detailRow.querySelector("canvas.radar-chart");
          if (canvasRadar && !charts[`radar-${pid}`]) {
             const radarData = JSON.parse(canvasRadar.dataset.radar || "{}");
             if (radarData.labels && radarData.labels.length) {
                 const ctxR = canvasRadar.getContext('2d');
                 charts[`radar-${pid}`] = new Chart(ctxR, {
                     type: 'radar',
                     data: {
                         labels: radarData.labels,
                         datasets: [{
                             label: 'Winrate %',
                             data: radarData.data,
                             borderColor: '#f97316', // Orange
                             backgroundColor: 'rgba(249, 115, 22, 0.2)',
                             pointBackgroundColor: '#f97316',
                             borderWidth: 1.5,
                             pointRadius: 2
                         }]
                     },
                     options: {
                         responsive: true, maintainAspectRatio: false,
                         scales: {
                             r: {
                                 beginAtZero: true,
                                 max: 100,
                                 ticks: { display: false, maxTicksLimit: 3 },
                                 grid: { color: 'rgba(255,255,255,0.05)' },
                                 angleLines: { color: 'rgba(255,255,255,0.05)' },
                                 pointLabels: { color: 'rgba(255,255,255,0.4)', font: { size: 9 } }
                             }
                         },
                         plugins: {
                             legend: { display: false }
                         }
                     }
                 });
             }
          }

          // ELO Chart Init
          if (!charts[pid]) {
          const canvas = detailRow.querySelector("canvas.elo-chart");
          if (canvas) {
            const hist = JSON.parse(canvas.dataset.history || "[]");
            if (hist.length) {
              const ctx = canvas.getContext('2d');
              const gradient = ctx.createLinearGradient(0, 0, 0, 400);
              gradient.addColorStop(0, 'rgba(0, 242, 255, 0.2)');
              gradient.addColorStop(1, 'rgba(0, 242, 255, 0)');

              charts[pid] = new Chart(ctx, {
                type: 'line',
                data: {
                  labels: hist.map(h => new Date(h.date * 1000).toLocaleDateString()),
                  datasets: [{
                    data: hist.map(h => h.elo),
                    borderColor: '#00f2ff',
                    backgroundColor: gradient,
                    borderWidth: 2,
                    pointBackgroundColor: '#00f2ff',
                    pointRadius: 0,
                    pointHoverRadius: 6,
                    fill: true,
                    tension: 0.4
                  }]
                },
                options: {
                  responsive: true, maintainAspectRatio: false,
                  interaction: { mode: 'index', intersect: false },
                  plugins: {
                    legend: { display: false },
                    tooltip: {
                      mode: 'index', intersect: false,
                      backgroundColor: 'rgba(5, 5, 16, 0.9)',
                      titleColor: '#fff', bodyColor: '#00f2ff',
                      borderColor: 'rgba(255,255,255,0.1)', borderWidth: 1
                    }
                  },
                  scales: {
                    x: { display: false },
                    y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#666' } }
                  }
                }
              });
            }
          }
        }
      }
    }
  });

    // --- Comparison Chart ---
    const CHART_COLORS = ['#00f2ff', '#FF5500', '#bd00ff', '#22c55e', '#eab308', '#f43f5e', '#3b82f6', '#a855f7'];
    let comparisonChart = null;
    const selectedPlayers = new Set();

    function initComparisonSection() {
      const data = window.COMPARISON_DATA;
      if (!data || !data.length) return;

      const container = document.getElementById('comparison-chips');
      data.forEach((p, i) => {
        const chip = document.createElement('button');
        chip.className = 'comparison-chip px-3 py-1.5 rounded-full text-xs font-bold border border-white/10 bg-white/5 text-white/60 hover:text-white flex items-center gap-2';
        chip.dataset.playerId = p.id;
        chip.dataset.colorIndex = i % CHART_COLORS.length;
        chip.innerHTML = `<div class="w-2 h-2 rounded-full" style="background:${CHART_COLORS[i % CHART_COLORS.length]}"></div>${p.nickname}`;
        chip.addEventListener('click', () => toggleComparisonPlayer(p.id, chip));
        container.appendChild(chip);
      });
    }

    function toggleComparisonPlayer(id, chip) {
      if (selectedPlayers.has(id)) {
        selectedPlayers.delete(id);
        chip.classList.remove('active');
      } else {
        selectedPlayers.add(id);
        chip.classList.add('active');
      }
      updateComparisonChart();
    }

    function updateComparisonChart() {
      const data = window.COMPARISON_DATA;
      if (!data) return;

      const canvas = document.getElementById('comparison-chart');
      const ctx = canvas.getContext('2d');

      if (comparisonChart) comparisonChart.destroy();

      const MAX_MATCHES = 30;
      const datasets = [];
      const selected = data.filter(p => selectedPlayers.has(p.id));

      selected.forEach((p, i) => {
        const chip = document.querySelector(`.comparison-chip[data-player-id="${p.id}"]`);
        const colorIdx = chip ? parseInt(chip.dataset.colorIndex) : i;
        const color = CHART_COLORS[colorIdx % CHART_COLORS.length];

        // Take only last 30 matches
        const recent = p.history.slice(-MAX_MATCHES);

        datasets.push({
          label: p.nickname,
          data: recent.map(h => h.elo),
          _dates: recent.map(h => new Date(h.date * 1000).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' })),
          borderColor: color,
          backgroundColor: 'transparent',
          borderWidth: 2.5,
          pointRadius: recent.length <= 15 ? 3 : 0,
          pointHoverRadius: 5,
          pointBackgroundColor: color,
          tension: 0.35
        });
      });

      if (datasets.length === 0) {
        comparisonChart = null;
        return;
      }

      // Labels: "Match 1" to "Match 30"
      const labels = Array.from({ length: MAX_MATCHES }, (_, i) => i + 1);

      comparisonChart = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets },
        options: {
          responsive: true, maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: { display: true, labels: { color: '#999', font: { size: 11 }, usePointStyle: true, pointStyle: 'line' } },
            tooltip: {
              backgroundColor: 'rgba(5,5,16,0.95)', titleColor: '#999',
              bodyFont: { weight: 'bold' },
              borderColor: 'rgba(255,255,255,0.1)', borderWidth: 1,
              callbacks: {
                title: (items) => `Match ${items[0].label} / 30`,
                afterTitle: (items) => {
                  // Show each player's actual date for this match index
                  return items.map(item => {
                    const ds = item.dataset;
                    return ds._dates && ds._dates[item.dataIndex] ? `${ds.label}: ${ds._dates[item.dataIndex]}` : '';
                  }).filter(Boolean).join('\n');
                },
                label: (item) => `  ${item.dataset.label}: ${item.formattedValue} ELO`
              }
            }
          },
          scales: {
            x: {
              title: { display: true, text: 'Letzte 30 Matches ‚Üí', color: '#555', font: { size: 10 } },
              ticks: { color: '#444', font: { size: 9 }, maxTicksLimit: 10 },
              grid: { color: 'rgba(255,255,255,0.03)' }
            },
            y: {
              grid: { color: 'rgba(255,255,255,0.05)' },
              ticks: { color: '#666' }
            }
          }
        }
      });
    }

    // --- Mobile Cards ---
    function buildMobileCards() {
      const container = document.querySelector('.mobile-cards');
      if (!container) return;
      container.innerHTML = '';

      const rows = Array.from(document.querySelectorAll('.player-row'));

      rows.forEach(row => {
        // Skip if row is hidden (search filter)
        if (row.style.display === 'none') return;

        const pid = row.dataset.playerId;
        const name = row.querySelector('.nickname-link')?.textContent || '‚Äî';
        const elo = row.dataset.elo;
        const level = row.dataset.level;
        const winrate = row.dataset.winrate;
        const matches = row.dataset.matches;
        const diff = row.dataset.diff || '0';
        const diffNum = parseInt(diff);
        const diffColor = diffNum > 0 ? 'text-green-400' : (diffNum < 0 ? 'text-red-400' : 'text-gray-500');
        const diffSign = diffNum > 0 ? '+' : '';
        const levelIcon = `icons/levels/level_${level}_icon.png`;

        const card = document.createElement('div');
        card.className = 'glass-card p-4 rounded-xl cursor-pointer transition-all active:scale-[0.98]';
        card.onclick = (e) => toggleMobileDetails(pid, card);

        // Find the history data from the desktop details row
        const desktopDetails = document.querySelector(`tr.details-row[data-player-id="${pid}"]`);
        const historyData = desktopDetails ? desktopDetails.querySelector('canvas')?.dataset.history : '[]';

        card.innerHTML = `
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-3">
              <img src="icons/levels/level_${level}_icon.png" class="w-8 h-8 drop-shadow-md">
              <div>
                <h3 class="font-bold text-white text-base">${name}</h3>
                <p class="text-xs text-white/40 font-mono">${matches} Matches</p>
              </div>
            </div>
            <div class="text-right">
              <p class="text-lg font-bold font-mono text-glow-blue text-white">${elo}</p>
              <p class="text-xs font-mono ${diffColor}">${diffSign}${diff}</p>
            </div>
          </div>
          <div class="w-full h-1.5 bg-black/40 rounded-full overflow-hidden border border-white/5 mb-3">
            <div class="h-full bg-gradient-to-r from-blue-600 to-neon-blue" style="width: ${winrate}%"></div>
          </div>
          <div class="flex justify-between text-xs text-white/40 font-mono">
            <span>Winrate: <span class="text-white">${winrate}%</span></span>
            <!-- <span>Last: ${row.dataset.last}</span> -->
          </div>
          <div class="mobile-details hidden mt-4 border-t border-white/5 pt-3">
             <p class="text-center text-xs text-white/20 mb-2">ELO Chart (Last 30)</p>
             <div class="h-24 w-full">
               <canvas class="mobile-chart" data-history='${historyData}'></canvas>
             </div>
          </div>
        `;
        container.appendChild(card);
      });
    }

    function toggleMobileDetails(pid, card) {
        const details = card.querySelector('.mobile-details');
        details.classList.toggle('hidden');
        if(!details.classList.contains('hidden')) {
            const canvas = details.querySelector('canvas');
            if(canvas && !canvas.dataset.rendered) {
                const hist = JSON.parse(canvas.dataset.history || "[]");
                if (hist.length) {
                    new Chart(canvas.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: hist.map(h => ""), 
                            datasets: [{
                                data: hist.map(h => h.elo),
                                borderColor: '#00f2ff',
                                borderWidth: 2,
                                pointRadius: 0,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: { legend: { display: false }, tooltip: { enabled: false } },
                            scales: { x: { display: false }, y: { display: false } }
                        }
                    });
                    canvas.dataset.rendered = "true";
                }
            }
        }
    }

    // --- Init ---
    updateView();
    initComparisonSection();
    applyRelativeTime();

  </script>
</body>

</html>